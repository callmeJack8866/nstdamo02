<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>NST - è®¢å• & äº¤æ˜“è®°å½• Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind ç”¨äº UI æ ·å¼ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ethers.js ç”¨äºè¿æ¥é’±åŒ… & è°ƒç”¨åˆçº¦ -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-50 min-h-screen">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="border-b border-slate-800 bg-slate-950/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-xl bg-gradient-to-br from-cyan-400 to-blue-600 flex items-center justify-center text-xs font-bold">
          NST
        </div>
        <div>
          <div class="font-semibold text-sm">NST Finance</div>
          <div class="text-[11px] text-slate-400">
            Non-Standard OTC Â· Orders & History Demo
          </div>
        </div>
      </div>
      <div class="flex items-center gap-3 text-xs">
        <div class="hidden sm:flex flex-col items-end">
          <span class="text-slate-400">å½“å‰é’±åŒ…</span>
          <span class="font-mono text-[11px] text-slate-200" id="currentWallet">
            0x1234...ABCD
          </span>
        </div>
        <button
          class="px-3 py-1.5 rounded-full bg-slate-800 border border-slate-700 text-[11px] hover:border-cyan-400"
          onclick="connectWallet()"
        >
          ğŸ’³ Connect Wallet
        </button>
      </div>
    </div>
  </header>

  <!-- é¡µé¢ä¸»ä½“ -->
  <main class="max-w-6xl mx-auto px-4 py-6 space-y-4">
    <!-- é¡¶éƒ¨æ ‡ç­¾ï¼šä¸‰ä¸ªè§†è§’ -->
    <section>
      <div class="flex flex-wrap gap-2 text-xs">
        <button
          class="view-tab px-3 py-1.5 rounded-full border border-cyan-500 bg-cyan-500/10"
          data-view="my-trades"
          onclick="switchView('my-trades', this)"
        >
          ğŸ‘¤ æˆ‘çš„äº¤æ˜“è®°å½•ï¼ˆå®¢æˆ·è§†è§’ï¼‰
        </button>
        <button
          class="view-tab px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 hover:border-cyan-400"
          data-view="order-detail"
          onclick="switchView('order-detail', this)"
        >
          ğŸ“„ è®¢å•è¯¦æƒ…è§†è§’
        </button>
        <button
          class="view-tab px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 hover:border-cyan-400"
          data-view="rater"
          onclick="switchView('rater', this)"
        >
          ğŸ§® æŠ¥ä»·å‘˜è§†è§’ï¼ˆå¾…å–‚ä»·è®¢å•ï¼‰
        </button>
      </div>
      <p class="mt-2 text-[11px] text-slate-500">
        æœ¬é¡µå½“å‰ä»ä½¿ç”¨å‡æ•°æ®ï¼Œç”¨äºæ¼”ç¤ºã€Œæ²¡æœ‰æœåŠ¡å™¨æ—¶ï¼ŒDApp å¦‚ä½•ä»é“¾ä¸Šè¯»æ•°æ®å¹¶æŒ‰ä¸åŒè§†è§’å±•ç¤ºã€çš„ UI ç»“æ„ã€‚
        <br />
        æœªæ¥æ¥å…¥æ™ºèƒ½åˆçº¦åï¼Œåªéœ€è¦åœ¨è„šæœ¬ä¸­å¡«å…¥ <span class="text-cyan-300">CONTRACT_ADDRESS / CONTRACT_ABI / loadOrdersFromChain()</span> å³å¯åˆ‡æ¢ä¸ºçœŸå®é“¾ä¸Šæ•°æ®ã€‚
      </p>
    </section>

    <!-- è§†è§’ Aï¼šæˆ‘çš„äº¤æ˜“è®°å½• -->
    <section id="view-my-trades" class="space-y-3">
      <h2 class="text-sm font-semibold">ğŸ‘¤ æˆ‘çš„äº¤æ˜“è®°å½•ï¼ˆæŒ‰å½“å‰é’±åŒ…è¿‡æ»¤ï¼‰</h2>
      <!-- ç­›é€‰ Tabs -->
      <div class="flex flex-wrap gap-2 text-xs">
        <button class="filter-tab px-3 py-1.5 rounded-full bg-slate-800 border border-cyan-500"
                data-status="all" onclick="setMyTradesFilter('all', this)">
          å…¨éƒ¨
        </button>
        <button class="filter-tab px-3 py-1.5 rounded-full bg-slate-800 border border-slate-700 hover:border-cyan-400"
                data-status="open" onclick="setMyTradesFilter('open', this)">
          è¿›è¡Œä¸­ï¼ˆæŒ‚å•/å·²æˆäº¤ï¼‰
        </button>
        <button class="filter-tab px-3 py-1.5 rounded-full bg-slate-800 border border-slate-700 hover:border-cyan-400"
                data-status="settled" onclick="setMyTradesFilter('settled', this)">
          å·²ç»“ç®—
        </button>
        <button class="filter-tab px-3 py-1.5 rounded-full bg-slate-800 border border-slate-700 hover:border-cyan-400"
                data-status="cancelled" onclick="setMyTradesFilter('cancelled', this)">
          å·²å–æ¶ˆ
        </button>
      </div>

      <!-- è®°å½•åˆ—è¡¨ -->
      <div id="myTradesList" class="space-y-2 text-xs">
        <!-- JS æ¸²æŸ“ -->
      </div>
    </section>

    <!-- è§†è§’ Bï¼šè®¢å•è¯¦æƒ…è§†è§’ -->
    <section id="view-order-detail" class="space-y-3 hidden">
      <h2 class="text-sm font-semibold">ğŸ“„ è®¢å•è¯¦æƒ…ï¼ˆåŒ…å«ç»“ç®— & æŠ¥ä»·è®°å½•ï¼‰</h2>
      <p class="text-[11px] text-slate-500">
        åœ¨çœŸå® DApp ä¸­ï¼Œè¿™ä¸€é¡µå¯ä»¥ä»ã€Œæˆ‘çš„äº¤æ˜“ã€ã€Œè®¢å•å¤§å…ã€ç‚¹å‡»æŸä¸ªè®¢å•è¡Œè·³è½¬è¿‡æ¥ã€‚è¿™é‡Œç”¨å‡æ•°æ®æ¨¡æ‹Ÿå…¶ä¸­ä¸€ä¸ªè®¢å•ã€‚
      </p>

      <!-- é€‰æ‹©è®¢å•ä¸‹æ‹‰ï¼ˆç”¨äºåˆ‡æ¢æŸ¥çœ‹å“ªä¸€ä¸ªï¼‰ -->
      <div class="text-xs space-y-1">
        <label class="text-slate-300">é€‰æ‹©è¦æŸ¥çœ‹çš„è®¢å•ï¼š</label>
        <select id="detailOrderSelect"
                class="bg-slate-950 border border-slate-700 rounded-lg px-2 py-1 text-xs"
                onchange="renderOrderDetail(parseInt(this.value))">
          <!-- JS æ·»åŠ é€‰é¡¹ -->
        </select>
      </div>

      <div class="grid gap-3 md:grid-cols-2 text-xs">
        <!-- å·¦ï¼šè®¢å•åŸºç¡€ä¿¡æ¯ -->
        <div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-3 space-y-2">
          <h3 class="font-semibold text-sm mb-1">è®¢å•ä¿¡æ¯</h3>
          <div id="detailOrderInfo" class="space-y-1">
            <!-- JS æ¸²æŸ“ -->
          </div>
        </div>

        <!-- å³ï¼šç»“ç®—ä¿¡æ¯ -->
        <div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-3 space-y-2">
          <h3 class="font-semibold text-sm mb-1">ç»“ç®— / ç›ˆäºï¼ˆç¤ºä¾‹ï¼‰</h3>
          <div id="detailSettleInfo" class="space-y-1">
            <!-- JS æ¸²æŸ“ -->
          </div>
        </div>
      </div>

      <!-- æŠ¥ä»·è®°å½• -->
      <div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-3 text-xs space-y-2">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold text-sm">æŠ¥ä»·å‘˜å–‚ä»·è®°å½•</h3>
          <span class="text-[11px] text-slate-400">çœŸå®ç¯å¢ƒä¸­æ¥è‡ª feeds[orderId]</span>
        </div>
        <div id="detailFeedsList" class="space-y-1">
          <!-- JS æ¸²æŸ“ -->
        </div>
      </div>
    </section>

    <!-- è§†è§’ Cï¼šæŠ¥ä»·å‘˜è§†è§’ -->
    <section id="view-rater" class="space-y-3 hidden">
      <h2 class="text-sm font-semibold">ğŸ§® æŠ¥ä»·å‘˜è§†è§’ï¼ˆå¾…å–‚ä»·çš„è®¢å•ï¼‰</h2>
      <p class="text-[11px] text-slate-500">
        è¿™ä¸ªè§†å›¾åªæ˜¾ç¤ºã€ŒçŠ¶æ€ä¸ºå·²æˆäº¤ï¼Œä½†å°šæœªç»“ç®—ã€ä¸”å½“å‰åœ¨æŠ¥ä»·çª—å£ä¸­çš„è®¢å•ï¼Œæ–¹ä¾¿æŠ¥ä»·å‘˜é›†ä¸­å¤„ç†ã€‚
      </p>

      <div id="raterOrdersList" class="space-y-2 text-xs">
        <!-- JS æ¸²æŸ“ -->
      </div>
    </section>
  </main>

  <script>
    // ======================================================
    // 1. é¢„ç•™åˆçº¦ä¿¡æ¯ï¼šå°†æ¥ä½ æœ‰çœŸå®åˆçº¦ååªæ”¹è¿™é‡Œ
    // ======================================================

    // TODOï¼šéƒ¨ç½²åˆçº¦åï¼ŒæŠŠçœŸå®åœ°å€å¡«åˆ°è¿™é‡Œ
    const CONTRACT_ADDRESS = "0xä½ çš„åˆçº¦åœ°å€";

    // TODOï¼šæŠŠä½ çš„æ™ºèƒ½åˆçº¦ ABI JSON ç²˜è´´åˆ°è¿™é‡Œ
    const CONTRACT_ABI = [
      // ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰ï¼šç­‰ä½ åˆçº¦ç»“æ„ç¡®å®šåå†å¡«
      // "function getOrdersByUser(address user) view returns (tuple(uint256 id,string symbol,string nameZh,uint256 notional,string side,address buyer,address seller,uint256 strike,uint256 feeRate,uint8 status,uint256 settlePrice,int256 pnlBuyer,int256 pnlSeller)[])",
    ];

    let provider = null;
    let signer   = null;
    let contract = null;
    let currentUser = null; // çœŸå®è¿æ¥çš„é’±åŒ…åœ°å€

    // Demo æ¨¡å¼ä¸‹çš„é»˜è®¤é’±åŒ…ï¼ˆæ²¡è¿æ¥æ—¶ç”¨å®ƒæ¥è¿‡æ»¤å‡æ•°æ®ï¼‰
    const demoUser = "0x1234...ABCD";

    // ======================================================
    // 2. è®¢å•çŠ¶æ€æšä¸¾
    // ======================================================

    const OrderStatus = {
      OPEN: "Open",         // æŒ‚å•ä¸­
      FILLED: "Filled",     // å·²æˆäº¤ï¼Œå¾…ç»“ç®—
      SETTLED: "Settled",   // å·²ç»“ç®—
      CANCELLED: "Cancelled"
    };

    // ======================================================
    // 3. å‡æ•°æ®ï¼šå½“å‰ç”¨å‰ç«¯æ¨¡æ‹Ÿé“¾ä¸Šæ•°æ®
    // ======================================================

    let orders = [
      {
        id: 1,
        symbol: "600519.SH",
        nameZh: "è´µå·èŒ…å°",
        notional: 1000000,
        side: "ä¹°æ¶¨",
        buyer: demoUser,
        seller: "0xSELLER-0001",
        strike: 1650,
        feeRate: 0.015,
        createdAt: "2025-11-01 10:23",
        expiredAt: "2025-11-10",
        status: OrderStatus.SETTLED,
        settlePrice: 1720,
        pnlBuyer: 50000,
        pnlSeller: -50000
      },
      {
        id: 2,
        symbol: "AAPL.O",
        nameZh: "è‹¹æœå…¬å¸",
        notional: 500000,
        side: "ä¹°è·Œ",
        buyer: "0xUSER-OTHER",
        seller: demoUser,
        strike: 180,
        feeRate: 0.012,
        createdAt: "2025-11-02 14:11",
        expiredAt: "2025-11-09",
        status: OrderStatus.FILLED,
        settlePrice: null,
        pnlBuyer: null,
        pnlSeller: null
      },
      {
        id: 3,
        symbol: "TSLA.O",
        nameZh: "ç‰¹æ–¯æ‹‰",
        notional: 300000,
        side: "ä¹°æ¶¨",
        buyer: demoUser,
        seller: "0xSELLER-0002",
        strike: 250,
        feeRate: 0.02,
        createdAt: "2025-11-03 09:00",
        expiredAt: "2025-11-15",
        status: OrderStatus.OPEN,
        settlePrice: null,
        pnlBuyer: null,
        pnlSeller: null
      },
      {
        id: 4,
        symbol: "BTCUSDT",
        nameZh: "æ¯”ç‰¹å¸æ°¸ç»­",
        notional: 200000,
        side: "ä¹°è·Œ",
        buyer: "0xUSER-OTHER2",
        seller: demoUser,
        strike: 70000,
        feeRate: 0.018,
        createdAt: "2025-11-04 16:45",
        expiredAt: "2025-11-06",
        status: OrderStatus.CANCELLED,
        settlePrice: null,
        pnlBuyer: null,
        pnlSeller: null
      }
    ];

    let feeds = {
      1: [
        {
          feeder: "0xRATER-0001",
          price: 1720,
          agree: true,
          comment: "å‚è€ƒä¸Šäº¤æ‰€æ”¶ç›˜ä»·",
          timestamp: "2025-11-10 15:05"
        },
        {
          feeder: "0xRATER-0002",
          price: 1718,
          agree: true,
          comment: "Wind æ”¶ç›˜åŠ æ»‘ç‚¹",
          timestamp: "2025-11-10 15:06"
        }
      ],
      2: [
        {
          feeder: "0xRATER-0003",
          price: 176,
          agree: true,
          comment: "çº³æ–¯è¾¾å…‹æ”¶ç›˜",
          timestamp: "2025-11-09 04:01"
        }
      ]
    };

    // ======================================================
    // 4. è¿æ¥é’±åŒ…ï¼ˆMetaMaskï¼‰
    // ======================================================

    async function connectWallet() {
      try {
        if (!window.ethereum) {
          alert("è¯·å…ˆå®‰è£… MetaMask æˆ–å…¶ä»– Web3 é’±åŒ…æ’ä»¶");
          return;
        }

        const accounts = await window.ethereum.request({
          method: "eth_requestAccounts",
        });

        if (!accounts || accounts.length === 0) {
          alert("æ²¡æœ‰å¯ç”¨çš„é’±åŒ…è´¦æˆ·");
          return;
        }

        currentUser = ethers.getAddress(accounts[0]);
        provider    = new ethers.BrowserProvider(window.ethereum);
        signer      = await provider.getSigner();

        // å¦‚æœå·²å¡«å…¥åˆçº¦ä¿¡æ¯ï¼Œåˆ™å®ä¾‹åŒ–åˆçº¦ï¼ˆç°åœ¨å¯ä»¥å…ˆä¸å¡«ï¼Œä¿æŒ nullï¼‰
        if (CONTRACT_ADDRESS !== "0xä½ çš„åˆçº¦åœ°å€" && CONTRACT_ABI.length > 0) {
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        }

        const short = currentUser.slice(0, 6) + "..." + currentUser.slice(-4);
        document.getElementById("currentWallet").textContent = short;

        // å°†æ¥æ”¹ä¸ºï¼šä»åˆçº¦è¯»å–å½“å‰é’±åŒ…ç›¸å…³è®¢å•
        await loadOrdersFromChain();

        // é‡æ–°æ¸²æŸ“è§†å›¾
        renderMyTrades();
        initDetailOrderSelect();
        if (orders.length > 0) renderOrderDetail(orders[0].id);
        renderRaterView();

        // alert("é’±åŒ…å·²è¿æ¥ï¼š" + currentUser);
      } catch (err) {
        console.error(err);
        alert("è¿æ¥é’±åŒ…å¤±è´¥ï¼š" + (err.message || err));
      }
    }

    // ======================================================
    // 5. é¢„ç•™ï¼šä»é“¾ä¸ŠåŠ è½½è®¢å•ï¼ˆæœªæ¥æ¥åˆçº¦æ—¶æ”¹è¿™é‡Œï¼‰
    // ======================================================

    async function loadOrdersFromChain() {
      // ç°åœ¨å…ˆä¸åŠ¨ï¼Œç»§ç»­ç”¨å‰ç«¯å‡æ•°æ®ã€‚
      // æœªæ¥ä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ä¼ªä»£ç æ¥æ”¹ï¼š

      /*
      if (!contract || !currentUser) return;

      const rawOrders = await contract.getOrdersByUser(currentUser);

      orders = rawOrders.map(o => ({
        id: Number(o.id),
        symbol: o.symbol,
        nameZh: o.nameZh,
        notional: Number(o.notional),
        side: o.side,
        buyer: o.buyer,
        seller: o.seller,
        strike: Number(o.strike),
        feeRate: Number(o.feeRate) / 1e4, // ä¸¾ä¾‹ï¼Œæ ¹æ®ä½ åˆçº¦å†…éƒ¨å­˜å‚¨çš„ç²¾åº¦æ¥å®š
        createdAt: formatTimestamp(o.createdAt),
        expiredAt: formatTimestamp(o.expiredAt),
        status: mapStatus(o.status),
        settlePrice: o.settlePrice ? Number(o.settlePrice) : null,
        pnlBuyer: o.pnlBuyer ? Number(o.pnlBuyer) : null,
        pnlSeller: o.pnlSeller ? Number(o.pnlSeller) : null,
      }));
      */
    }

    function formatTimestamp(ts) {
      const d = new Date(Number(ts) * 1000);
      const pad = n => (n < 10 ? "0" + n : n);
      return (
        d.getFullYear() + "-" +
        pad(d.getMonth() + 1) + "-" +
        pad(d.getDate()) + " " +
        pad(d.getHours()) + ":" +
        pad(d.getMinutes())
      );
    }

    function mapStatus(s) {
      // å°†æ¥åˆçº¦é‡Œå¯èƒ½æ˜¯ 0/1/2/3 çš„æšä¸¾ï¼Œè¿™é‡Œæ˜ å°„åˆ°å‰ç«¯å­—ç¬¦ä¸²
      if (s === 0) return OrderStatus.OPEN;
      if (s === 1) return OrderStatus.FILLED;
      if (s === 2) return OrderStatus.SETTLED;
      if (s === 3) return OrderStatus.CANCELLED;
      return OrderStatus.OPEN;
    }

    // ======================================================
    // 6. è§†å›¾åˆ‡æ¢
    // ======================================================

    function switchView(viewId, btn) {
      document.querySelectorAll('[id^="view-"]').forEach(sec => {
        sec.classList.add("hidden");
      });
      document.getElementById("view-" + viewId).classList.remove("hidden");

      document.querySelectorAll(".view-tab").forEach(b => {
        b.classList.remove("border-cyan-500", "bg-cyan-500/10");
        b.classList.add("border-slate-700", "bg-slate-900");
      });
      btn.classList.remove("border-slate-700", "bg-slate-900");
      btn.classList.add("border-cyan-500", "bg-cyan-500/10");
    }

    // ======================================================
    // 7. æˆ‘çš„äº¤æ˜“è®°å½•è§†è§’
    // ======================================================

    let myTradesFilter = "all";

    function setMyTradesFilter(status, btn) {
      myTradesFilter = status;
      document.querySelectorAll(".filter-tab").forEach(b => {
        b.classList.remove("border-cyan-500");
        b.classList.add("border-slate-700");
      });
      btn.classList.remove("border-slate-700");
      btn.classList.add("border-cyan-500");
      renderMyTrades();
    }

    function renderMyTrades() {
      const container = document.getElementById("myTradesList");
      container.innerHTML = "";

      const user = currentUser || demoUser;

      const myOrders = orders.filter(
        o => o.buyer === user || o.seller === user
      );

      const filtered = myOrders.filter(o => {
        if (myTradesFilter === "all") return true;
        if (myTradesFilter === "open") {
          return o.status === OrderStatus.OPEN || o.status === OrderStatus.FILLED;
        }
        if (myTradesFilter === "settled") {
          return o.status === OrderStatus.SETTLED;
        }
        if (myTradesFilter === "cancelled") {
          return o.status === OrderStatus.CANCELLED;
        }
        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML =
          '<div class="text-[11px] text-slate-500">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹ï¼Œæ²¡æœ‰æ‰¾åˆ°äº¤æ˜“è®°å½•ã€‚</div>';
        return;
      }

      filtered.forEach(o => {
        const role = o.buyer === user ? "ä¹°æ–¹" : "å–æ–¹";
        const roleColor =
          role === "ä¹°æ–¹" ? "text-emerald-300" : "text-sky-300";

        const statusLabel = {
          [OrderStatus.OPEN]: "æŒ‚å•ä¸­",
          [OrderStatus.FILLED]: "å·²æˆäº¤Â·å¾…ç»“ç®—",
          [OrderStatus.SETTLED]: "å·²ç»“ç®—",
          [OrderStatus.CANCELLED]: "å·²å–æ¶ˆ"
        }[o.status];

        const statusColor = {
          [OrderStatus.OPEN]: "bg-slate-800 text-slate-100",
          [OrderStatus.FILLED]: "bg-amber-500/10 text-amber-300 border-amber-500/40",
          [OrderStatus.SETTLED]: "bg-emerald-500/10 text-emerald-300 border-emerald-500/40",
          [OrderStatus.CANCELLED]: "bg-slate-800 text-slate-400"
        }[o.status];

        const pnlText =
          o.status === OrderStatus.SETTLED && o.buyer === user
            ? `ä¹°æ–¹ç›ˆäºï¼š${formatPnL(o.pnlBuyer)}`
            : o.status === OrderStatus.SETTLED && o.seller === user
            ? `å–æ–¹ç›ˆäºï¼š${formatPnL(o.pnlSeller)}`
            : "å°šæœªç»“ç®—";

        const div = document.createElement("div");
        div.className =
          "bg-slate-900/70 border border-slate-800 rounded-xl p-3 flex flex-col gap-1 hover:border-cyan-500/40 cursor-pointer";
        div.onclick = () => {
          const detailTab = document.querySelector(
            '.view-tab[data-view="order-detail"]'
          );
          switchView("order-detail", detailTab);
          document.getElementById("detailOrderSelect").value = o.id;
          renderOrderDetail(o.id);
        };
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="font-mono text-[11px] text-slate-400">#${o.id}</span>
              <span class="text-xs font-semibold">${o.nameZh}</span>
              <span class="text-[11px] text-slate-400">${o.symbol}</span>
              <span class="text-[11px] px-2 py-0.5 rounded-full border ${statusColor}">
                ${statusLabel}
              </span>
            </div>
            <span class="text-[11px] text-slate-400">${o.createdAt}</span>
          </div>
          <div class="flex items-center justify-between text-[11px]">
            <div class="flex flex-col gap-0.5">
              <span>æ–¹å‘ï¼š<span class="text-slate-100">${o.side}</span> Â· <span class="${roleColor}">${role}</span></span>
              <span>åä¹‰æœ¬é‡‘ï¼š<span class="text-slate-100">${fmt(o.notional)} THBï¼ˆç¤ºä¾‹ï¼‰</span></span>
              <span>æ ¡éªŒä»·æ ¼ï¼š<span class="text-slate-100">${o.strike}</span></span>
            </div>
            <div class="flex flex-col items-end gap-0.5">
              <span>è´¹ç‡ï¼š<span class="text-slate-100">${(o.feeRate * 100).toFixed(1)}%</span></span>
              <span>${pnlText}</span>
              <span class="text-slate-500">åˆ°æœŸæ—¥ï¼š${o.expiredAt}</span>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function fmt(n) {
      return n.toLocaleString("zh-CN");
    }

    function formatPnL(x) {
      if (x == null) return "â€”";
      const v = Number(x);
      if (v > 0) return `+${fmt(v)}`;
      if (v < 0) return `-${fmt(Math.abs(v))}`;
      return "0";
    }

    // ======================================================
    // 8. è®¢å•è¯¦æƒ…è§†è§’
    // ======================================================

    function initDetailOrderSelect() {
      const sel = document.getElementById("detailOrderSelect");
      sel.innerHTML = "";
      orders.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.id;
        opt.textContent = `#${o.id} Â· ${o.nameZh} Â· ${o.symbol}`;
        sel.appendChild(opt);
      });
    }

    function renderOrderDetail(orderId) {
      const o = orders.find(x => x.id === orderId);
      if (!o) return;

      const infoDiv = document.getElementById("detailOrderInfo");
      const settleDiv = document.getElementById("detailSettleInfo");
      const feedsDiv = document.getElementById("detailFeedsList");

      const statusLabel = {
        [OrderStatus.OPEN]: "æŒ‚å•ä¸­",
        [OrderStatus.FILLED]: "å·²æˆäº¤Â·å¾…ç»“ç®—",
        [OrderStatus.SETTLED]: "å·²ç»“ç®—",
        [OrderStatus.CANCELLED]: "å·²å–æ¶ˆ"
      }[o.status];

      infoDiv.innerHTML = `
        <div>è®¢å•å·ï¼š<span class="font-mono text-slate-100">#${o.id}</span></div>
        <div>æ ‡çš„ï¼š<span class="text-slate-100">${o.nameZh}</span>ï¼ˆ${o.symbol}ï¼‰</div>
        <div>æ–¹å‘ï¼š<span class="text-slate-100">${o.side}</span></div>
        <div>åä¹‰æœ¬é‡‘ï¼š<span class="text-slate-100">${fmt(o.notional)}</span></div>
        <div>æ ¡éªŒä»·æ ¼ï¼š<span class="text-slate-100">${o.strike}</span></div>
        <div>è´¹ç‡ï¼š<span class="text-slate-100">${(o.feeRate * 100).toFixed(1)}%</span></div>
        <div>ä¹°æ–¹åœ°å€ï¼š<span class="font-mono text-[11px] text-slate-300">${o.buyer}</span></div>
        <div>å–æ–¹åœ°å€ï¼š<span class="font-mono text-[11px] text-slate-300">${o.seller}</span></div>
        <div>åˆ›å»ºæ—¶é—´ï¼š<span class="text-slate-300">${o.createdAt}</span></div>
        <div>åˆ°æœŸæ—¶é—´ï¼š<span class="text-slate-300">${o.expiredAt}</span></div>
        <div>è®¢å•çŠ¶æ€ï¼š<span class="text-slate-100">${statusLabel}</span></div>
      `;

      if (o.status === OrderStatus.SETTLED) {
        settleDiv.innerHTML = `
          <div>ç»“ç®—ä»·æ ¼ï¼š<span class="text-emerald-300">${o.settlePrice}</span></div>
          <div>ä¹°æ–¹ç›ˆäºï¼š<span class="text-emerald-300">${formatPnL(o.pnlBuyer)}</span></div>
          <div>å–æ–¹ç›ˆäºï¼š<span class="text-rose-300">${formatPnL(o.pnlSeller)}</span></div>
          <div class="text-[11px] text-slate-500 mt-1">
            æ³¨ï¼šç›ˆäºç”±ä¿è¯é‡‘åˆçº¦åœ¨ç»“ç®—æ—¶è‡ªåŠ¨æ‰£/è¿”ï¼Œå‰ç«¯åªæ˜¯è¯»å–ç»“æœæ˜¾ç¤ºã€‚
          </div>
        `;
      } else if (o.status === OrderStatus.FILLED) {
        settleDiv.innerHTML = `
          <div>ç»“ç®—ä»·æ ¼ï¼š<span class="text-slate-300">å°šæœªç»“ç®—</span></div>
          <div>ä¹°æ–¹ç›ˆäºï¼š<span class="text-slate-300">å¾…ç»“ç®—</span></div>
          <div>å–æ–¹ç›ˆäºï¼š<span class="text-slate-300">å¾…ç»“ç®—</span></div>
          <div class="text-[11px] text-amber-300 mt-1">
            å½“å‰è®¢å•å·²æˆäº¤ï¼Œç­‰å¾…æŠ¥ä»·å‘˜å–‚ä»·å¹¶å®Œæˆç»“ç®—ã€‚
          </div>
        `;
      } else {
        settleDiv.innerHTML = `
          <div>ç»“ç®—ä»·æ ¼ï¼š<span class="text-slate-300">â€”</span></div>
          <div>ä¹°æ–¹ç›ˆäºï¼š<span class="text-slate-300">â€”</span></div>
          <div>å–æ–¹ç›ˆäºï¼š<span class="text-slate-300">â€”</span></div>
          <div class="text-[11px] text-slate-500 mt-1">
            ä»…åœ¨è®¢å•çŠ¶æ€ä¸ºã€Œå·²ç»“ç®—ã€æ—¶æ‰ä¼šæœ‰ç»“ç®—ä¿¡æ¯ã€‚
          </div>
        `;
      }

      const f = feeds[orderId] || [];
      feedsDiv.innerHTML = "";
      if (f.length === 0) {
        feedsDiv.innerHTML =
          '<div class="text-[11px] text-slate-500">å½“å‰è®¢å•æš‚æ— æŠ¥ä»·è®°å½•ã€‚</div>';
      } else {
        f.forEach(rec => {
          const item = document.createElement("div");
          item.className =
            "border border-slate-800 rounded-lg px-3 py-2 flex flex-col gap-0.5";
          item.innerHTML = `
            <div class="flex items-center justify-between">
              <span class="font-mono text-[11px] text-slate-300">${rec.feeder}</span>
              <span class="text-[11px] text-slate-400">${rec.timestamp}</span>
            </div>
            <div>å–‚ä»·ï¼š<span class="text-slate-100">${rec.price}</span></div>
            <div>æ€åº¦ï¼š<span class="${rec.agree ? "text-emerald-300" : "text-rose-300"}">
              ${rec.agree ? "åŒæ„ç»“ç®—" : "å­˜åœ¨å¼‚è®®"}
            </span></div>
            <div class="text-[11px] text-slate-400">å¤‡æ³¨ï¼š${rec.comment}</div>
          `;
          feedsDiv.appendChild(item);
        });
      }
    }

    // ======================================================
    // 9. æŠ¥ä»·å‘˜è§†è§’
    // ======================================================

    function renderRaterView() {
      const container = document.getElementById("raterOrdersList");
      container.innerHTML = "";

      const pending = orders.filter(o => o.status === OrderStatus.FILLED);

      if (pending.length === 0) {
        container.innerHTML =
          '<div class="text-[11px] text-slate-500">å½“å‰æ²¡æœ‰éœ€è¦æŠ¥ä»·çš„è®¢å•ã€‚</div>';
        return;
      }

      pending.forEach(o => {
        const div = document.createElement("div");
        const feedForThisOrder = feeds[o.id] || [];

        div.className =
          "bg-slate-900/70 border border-slate-800 rounded-xl p-3 space-y-2";

        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="font-mono text-[11px] text-slate-400">#${o.id}</span>
              <span class="text-xs font-semibold">${o.nameZh}</span>
              <span class="text-[11px] text-slate-400">${o.symbol}</span>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-amber-500/10 text-amber-300 border border-amber-500/40">
                å·²æˆäº¤Â·å¾…æŠ¥ä»·
              </span>
            </div>
            <span class="text-[11px] text-slate-400">åˆ°æœŸï¼š${o.expiredAt}</span>
          </div>
          <div class="flex items-center justify-between text-[11px]">
            <div class="flex flex-col gap-0.5">
              <span>æ–¹å‘ï¼š<span class="text-slate-100">${o.side}</span></span>
              <span>åä¹‰æœ¬é‡‘ï¼š<span class="text-slate-100">${fmt(o.notional)}</span></span>
              <span>æ ¡éªŒä»·æ ¼ï¼š<span class="text-slate-100">${o.strike}</span></span>
            </div>
            <div class="flex flex-col items-end gap-0.5">
              <span>å·²æœ‰æŠ¥ä»·è®°å½•ï¼š<span class="text-slate-100">${feedForThisOrder.length}</span> æ¡</span>
              <span class="text-slate-500">ä¸Šæ¬¡æŠ¥ä»·æ—¶é—´ï¼š${
                feedForThisOrder.length
                  ? feedForThisOrder[feedForThisOrder.length - 1].timestamp
                  : "â€”"
              }</span>
            </div>
          </div>
          <div class="mt-2 flex flex-col gap-1 text-[11px]">
            <label>ä½œä¸ºæŠ¥ä»·å‘˜ï¼Œåœ¨æ­¤è¾“å…¥ä½ å»ºè®®çš„ç»“ç®—ä»·æ ¼ï¼ˆDemoï¼Œä¸ä¸Šé“¾ï¼‰ï¼š</label>
            <div class="flex gap-2">
              <input type="number" min="0" step="0.01"
                    placeholder="ä¾‹å¦‚ï¼š176.50"
                    class="flex-1 bg-slate-950 border border-slate-700 rounded-lg px-2 py-1 text-xs focus:outline-none focus:border-cyan-400" />
              <button
                class="px-3 py-1 rounded-lg bg-cyan-500 text-slate-950 text-[11px] font-semibold hover:bg-cyan-400"
                onclick="alert('Demoï¼šè¿™é‡Œæœªæ¥ä¼šè°ƒç”¨ feedPrice(orderId, price, agree, comment) å†™å…¥é“¾ä¸Š')"
              >
                æäº¤å–‚ä»·ï¼ˆDemoï¼‰
              </button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // ======================================================
    // 10. åˆå§‹åŒ–
    // ======================================================

    function init() {
      document.getElementById("currentWallet").textContent = demoUser;
      renderMyTrades();
      initDetailOrderSelect();
      if (orders.length > 0) renderOrderDetail(orders[0].id);
      renderRaterView();
    }

    init();
  </script>
</body>
</html>
